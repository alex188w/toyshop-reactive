# Приложение "Витрина интернет-магазина" с сервисом платежей с использованием Spring Framework

## На основе существующего проекта седьмого спринта «Витрина интернет-магазина с сервисом платежей»:

    * добавлена авторизация/регистрация покупателя в приложении «Витрина интернет-магазина»;

    * добавлена авторизация взаимодействия между приложением «Витрина интернет-магазина» и RESTful-сервисом платежей.

## Функциональность

1. В проект добавлен Spring Security в качестве модуля авторизации Spring Boot-приложений.

2. В приложении «Витрина интернет-магазина» реализована авторизация и регистрация пользователя (покупателя) по логину/паролю.

3. Данные пользователя сохраняются в БД (логин/пароль в зашифрованном виде) — Spring Security использует эту информацию для аутентификации/авторизации пользователя. При логауте пользователя полностью очищаться все связанные с ним куки, HttpSession и т. д., то есть пользователь полностью разлогинен.

4. С каждым авторизованным пользователем связаны его индивидуальная корзина с покупками и заказы:

    * При логине пользователь имеет доступ только к своей корзине.

    * Пользователь может совершать покупку только для своей корзины.

    * Пользователь может видеть только свои заказы.

5. В приложении «Витрина интернет-магазина»:

    * Все пользователи делятся на авторизованных и анонимных.

    * У анонимного пользователя есть доступ только к витрине товаров и к карточке самого товара, при этом он не может добавлять товары в корзину, переходить в корзину и заказы.

    * У авторизованного пользователя есть доступ ко всем страницам и элементам управления (кнопкам добавления заказа, осуществления платежа и т. д.).

    * Реализована защита доступа анонимного пользователя к недоступным ресурсам как на HTML-уровне (кнопки, ссылки на недоступные ему ресурсы не показываются), так и на уровне эндпоинтов контроллеров приложения (должна показываться соответствующая ошибка).

6. В проект добавлен сервер авторизации OAuth2 - Keycloack. Настройка сервера приведена в файле Readme_KeyKloak.md.

    * Сервер авторизации должен быть запущен локально.

    * В HTTP-клиент для осуществления запросов в RESTful-сервис платежей приложения «Витрина интернет-магазина» реализована возможность OAuth2-авторизации (используются данные клиента, зарегистрированного в сервисе авторизации).

    * В RESTful-сервисе платежей реализована возможность авторизации приложения «Витрина интернет-магазина» как клиента для доступа к эндпоинтам проверки баланса и осуществления платежа (используются данные сервера ресурсов, зарегистрированного в сервисе авторизации).

    * Если приложение «Витрина интернет-магазина» как клиент не авторизовано в сервисе авторизации, то оно не имеет возможность выполнять запросы к RESTful-сервису платежей как к серверу ресурсов (должно получать соответствующую ошибку).


## Краткое описание взаимодействия storeFront и paymentService через КейКлок

 * storeFront (клиент) вызывает API paymentService.

 * storeFront получает access token от Keycloak (через client_credentials или от имени пользователя).

 * В каждом запросе к paymentService storeFront добавляет заголовок:

Authorization: Bearer <access_token>

 * paymentService (ресурс-сервер) проверяет токен у Keycloak (через public key / JWKS).

Если токен валидный и роль/права подходят → выполняется бизнес-логика (например, платёж).

 * Keycloak — это единая точка аутентификации и авторизации, storeFront отвечает за получение токена, а paymentService — за проверку и доверие к этому токену.

Иначально приложение разрабатывалось с возможностью регистрации и аутентификации пользоавтеля на сервере Keycloak, но пришлось регистрацию/аутентификацию выполнять в прилоожению по следующей причине:

 * В реактивном WebFlux при использовании oauth2Login роли из Keycloak не попадают в SecurityContext автоматически как ROLE_XXX.

 * OAuth2Login создает OAuth2AuthenticationToken, который имеет OidcUser в principal.
GrantedAuthorities из Keycloak — это обычно SCOPE_* + OIDC_USER, а не роли из realm_access.roles.
 * Поэтому .hasRole("ADMIN") не срабатывает — в SecurityContext нет ROLE_ADMIN.

Получилось реализовать, чтобы роли попадали в SecurityContext из OidcUser Keycloak с помощью кастомных методов, но реактивная работа приложения при этом нарушалась.

## Запуск приложения в работу

Для корректной работы приложения необходимо: 

1. локально запутить в работу сервер авторизации OAuth2 - Keycloack;

2. локально запустить в работу Сервис Redis;

3. Переименовать файлы storefront\src\main\resources\application.template.yml и paymentService\src\main\resources\application.template.yml в storefront\src\main\resources\application.yml и paymentService\src\main\resources\application.yml - сответственно и заполнить в них Client Secret, взятыми из Realm KeyKloak.

4. Сборка и запуск приложения из исходников локально на хостовой машине ОС Виндовс возможна командами:

 **mvn spring-boot:run -pl paymentService** - запуск сервиса платежей

 **mvn spring-boot:run -pl storefront "-Dspring-boot.run.profiles=local"** - запуск основного приложения

## Работа приложения в контейнере

Для сборки сервисов необходимо:

В корне каждого сервиса (например, storefront/): выполнить команду: mvn clean package -DskipTests. Затем создать образ командой docker build -t username/storefront:latest .

То же самое сделать для paymentService.

Затем запустить приложение в работу в контейнерах командой docker-compose up. docker-compose.yml, необходимый для работы данного находится в корне проекта.

В application.yml у сервисов URL Keycloak изменить на http://host.docker.internal:8080 (иначе из контейнера он не достучится до Windows-хоста).

Keycloak и Redis должны быть запущены локально на хостовой машине.

Образы сервисов доступны по адресу:

    https://hub.docker.com/repository/docker/alex188w/storefront/general

    https://hub.docker.com/repository/docker/alex188w/paymentservice/general



## Тестирование приложения

Для тестирования данного приложения всего разработан 51 интеграционных и JUNIT тестов, в том числе тестирующих работу взаимодействия сервисов.

## Скрины работы Приложения

Регистрация/логин

![Регистрация/логин](img/login.jpg)

Добавление товара на страницу (доступно только пользователь с ROLE_ADMIN)

![Добавление товара](img/admin.jpg)

Заказ

![Заказ](img/payment3.jpg)

Вход гостем

![Гость](img/quest.jpg)


Тестирование

![test](img/paymentServiceTest.jpg)


![test](img/paymentServiceClient.jpg)

![test](img/storeFrontTest2.jpg)




